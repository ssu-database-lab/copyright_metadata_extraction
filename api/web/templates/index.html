<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal OCR & NER 엔티티 추출</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 2100px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 600;
        }
        
        header p {
            font-size: 1.3rem;
            color: #718096;
            margin-bottom: 0;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* 업로드 영역 */
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 50px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: #4299e1;
            background: #f7fafc;
        }

        .upload-area.dragover {
            border-color: #4299e1;
            background: #ebf8ff;
            transform: scale(1.01);
        }

        .upload-area h3 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .upload-area p {
            color: #718096;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 15px 35px;
            border-radius: 6px;
            font-size: 1.2rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* 모델 선택 */
        .model-selection {
            margin-bottom: 30px;
        }

        .model-selection h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.5rem;
        }

        .model-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .model-option {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .model-option:hover {
            border-color: #4299e1;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.15);
        }

        .model-option.selected {
            border-color: #4299e1;
            background: #ebf8ff;
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.2);
        }

        .model-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f5f5f5;
        }

        .model-option.disabled:hover {
            border-color: #e0e0e0;
            transform: none;
            box-shadow: none;
        }

        .setup-required {
            color: #e53e3e;
            font-size: 0.75rem;
            margin-top: 5px;
            font-weight: 500;
        }

        .model-option input[type="radio"] {
            margin-right: 10px;
        }

        .model-option input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .checkbox-option {
            border-style: dashed;
        }

        .checkbox-option:hover {
            border-style: solid;
        }

        .checkbox-option.selected {
            border-style: solid;
            border-color: #10B981;
            background: #f0fdf4;
        }

        .checkbox-option {
            max-width: 300px;
            margin: 0;
        }

        .checkbox-option .model-name {
            font-size: 1rem;
            margin-bottom: 3px;
        }

        .checkbox-option .model-desc {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .checkbox-option .model-icon {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            margin: 0 8px 0 0;
            display: inline-block;
        }

        .model-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
            font-size: 1.2rem;
        }
        
        .model-icon {
            width: 150px;
            height: 150px;
            flex-shrink: 0;
            border-radius: 80px;
            object-fit: contain;
            display: block;
            margin: -50px -2px -100px auto;
            max-width: 100%;
        }

        .model-desc {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 8px;
        }

        .model-stats {
            display: flex;
            justify-content: space-between;
            font-size: 1rem;
            color: #999;
        }

        /* 파일 정보 */
        .file-info {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .file-size {
            color: #666;
            font-size: 0.9rem;
        }

        /* 진행 상황 */
        .progress-section {
            display: none;
            margin-top: 30px;
        }

        .progress-section.show {
            display: block;
        }

        .progress-bar-container {
            background: #e0e0e0;
            border-radius: 50px;
            height: 30px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-bar {
            background: #4299e1;
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .progress-steps {
            list-style: none;
        }

        .progress-step {
            padding: 10px;
            border-left: 3px solid #e0e0e0;
            margin-left: 10px;
            color: #999;
        }

        .progress-step.active {
            border-left-color: #4299e1;
            color: #4299e1;
            font-weight: 500;
        }

        .progress-step.completed {
            border-left-color: #4caf50;
            color: #4caf50;
        }

        /* 결과 영역 */
        .result-section {
            display: none;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }

        .result-section.show {
            display: block;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .result-title {
            font-size: 1.5rem;
            color: #333;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8f9ff;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: #4299e1;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .entities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .entity-card {
            background: #4299e1;
            color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(66, 153, 225, 0.2);
        }

        .entity-type {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .entity-count {
            font-size: 2rem;
            font-weight: 700;
        }

        .download-btn {
            margin-top: 20px;
            width: 100%;
        }

        /* 에러 메시지 */
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* 로딩 애니메이션 */
        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        .spinner.show {
            display: block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 스트리밍 결과 스타일 */
        .streaming-result {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .streaming-result h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .streaming-content {
            background: white;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* 반응형 */
        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }

            .main-card {
                padding: 25px;
            }

            .model-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Universal OCR & NER 엔티티 추출</h1>
            <p>Universal OCR 시스템과 NER 모델을 사용하여 문서에서 정보를 추출합니다</p>
        </header>

        <div class="main-card">
            <!-- Universal OCR 선택 -->
            <div class="model-selection">
                <!-- <h3>Universal OCR 처리</h3>
                <div class="model-options">
                    <label class="model-option selected">
                        <input type="radio" name="processing_mode" value="universal" checked>
                        <div>
                            <div class="model-name">Universal OCR</div>
                            <div class="model-desc">통합 OCR 처리 (Google, Mistral, Alibaba Cloud)</div>
                        </div>
                    </label>
                </div> -->
                
                <!-- Universal OCR 설정 -->
                <div id="universalOcrSettings" style="margin-top: 20px;">
                    <div class="model-selection">
                        <h3>Universal OCR 설정</h3>
                        <div class="model-options">
                            <label class="model-option">
                                <input type="radio" name="universal_provider" value="google" checked>
                                <div>
                                    <div class="model-name">
                                        <img class="model-icon" src="https://www.simpleocr.com/wp-content/uploads/2022/04/google_vision_cloud_ocr_api.jpg" alt="Google Cloud Vision">
                                        Google Cloud Vision
                                    </div>
                                    <div class="model-desc">텍스트 분석률 좋음</div>
                                </div>
                            </label>
                            <label class="model-option">
                                <input type="radio" name="universal_provider" value="mistral">
                                <div>
                                    <div class="model-name">
                                        <img class="model-icon" src="https://parsio.io/blog/content/images/size/w2000/2025/03/mistralocr-1.jpg" alt="Mistral OCR">
                                        Mistral OCR
                                    </div>
                                    <div class="model-desc">OCR 특화 모델, 높은 정확도</div>
                                </div>
                            </label>
                            <label class="model-option">
                                <input type="radio" name="universal_provider" value="naver">
                                <div>
                                    <div class="model-name">
                                        <img class="model-icon" src="https://cdn.aitimes.kr/news/photo/202012/18725_20610_574.jpg" alt="Naver CLOVA OCR">
                                        Naver CLOVA OCR
                                    </div>
                                    <div class="model-desc">표 분석에 강함</div>
                                </div>
                            </label>
                            <label class="model-option">
                                <input type="radio" name="universal_provider" value="alibaba">
                                <div>
                                    <img class="model-icon" src="https://www.nexusgroup.com/wp-content/uploads/2020/03/alibaba-cloud-logo.png" alt="Alibaba Cloud Qwen3-VL">
                                    <div class="model-name">Alibaba Cloud Qwen3-VL</div>
                                    <div class="model-desc">한국어 문서 특화, 최신 Qwen3 모델</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="model-selection" id="alibabaModelSelection" style="display: none;">
                        <h4>Alibaba Cloud 모델 선택</h4>
                        <div class="model-options">
                            <label class="model-option">
                                <input type="radio" name="alibaba_model" value="qwen-vl-plus" checked>
                                <div>
                                    <img class="model-icon" src="https://camo.githubusercontent.com/cc1b109f5c535ef826fb7016cea473bdf286c14ccf75481c76a0a0f0331e9edb/68747470733a2f2f7169616e77656e2d7265732e6f73732d616363656c65726174652e616c6979756e63732e636f6d2f5177656e332d564c2f7177656e33766c6c6f676f2e706e67" alt="Qwen3-VL-Plus">
                                    <div class="model-name">Qwen3-VL-Plus</div>
                                    <div class="model-desc">최신 Qwen3 Vision 모델</div>
                                </div>
                            </label>
                            <label class="model-option">
                                <input type="radio" name="alibaba_model" value="qwen3-vl-30b-a3b-instruct">
                                <div>
                                    <img class="model-icon" src="https://camo.githubusercontent.com/cc1b109f5c535ef826fb7016cea473bdf286c14ccf75481c76a0a0f0331e9edb/68747470733a2f2f7169616e77656e2d7265732e6f73732d616363656c65726174652e616c6979756e63732e636f6d2f5177656e332d564c2f7177656e33766c6c6f676f2e706e67" alt="Qwen3-VL-30B">
                                    <div class="model-name">Qwen3-VL-30B</div>
                                    <div class="model-desc">30B 파라미터 모델</div>
                                </div>
                            </label>
                            <label class="model-option">
                                <input type="radio" name="alibaba_model" value="qwen3-vl-235b-a22b-instruct">
                                <div>
                                    <img class="model-icon" src="https://camo.githubusercontent.com/cc1b109f5c535ef826fb7016cea473bdf286c14ccf75481c76a0a0f0331e9edb/68747470733a2f2f7169616e77656e2d7265732e6f73732d616363656c65726174652e616c6979756e63732e636f6d2f5177656e332d564c2f7177656e33766c6c6f676f2e706e67" alt="Qwen3-VL-235B">
                                    <div class="model-name">Qwen3-VL-235B</div>
                                    <div class="model-desc">235B 파라미터 모델 (최고 성능)</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="model-selection">
                        <h4>처리 옵션</h4>
                        <div class="model-options">
                            <label class="model-option checkbox-option">
                                <input type="checkbox" name="streaming_mode" id="streamingMode">
                                <div>
                                    <div class="model-name">
                                        <img class="model-icon" src="https://upload.wikimedia.org/wikipedia/commons/8/8f/Microsoft_Stream.svg" alt="스트리밍 처리">
                                        스트리밍 처리
                                    </div>
                                    <div class="model-desc">실시간 결과 출력</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 모델 선택 -->
            <div class="model-selection">
                <h3>NER 모델 선택</h3>
                <div class="model-options">
                    {% for key, model in models.items() %}
                    <label class="model-option {% if loop.first %}selected{% endif %}">
                        <input type="radio" name="model" value="{{ key }}" {% if loop.first %}checked{% endif %}>
                        <div class="model-name">{{ model.display_name }}</div>
                        <div class="model-desc">{{ model.description }}</div>
                        <div class="model-stats">
                            <span>정확도: {{ model.accuracy }}</span>
                            <span>속도: {{ model.speed }}</span>
                        </div>
                    </label>
                    {% endfor %}
                </div>
            </div>

            <!-- 파일 업로드 -->
            <div class="upload-area" id="uploadArea">
                <h3>파일 업로드</h3>
                <p>다음 파일 형식을 지원합니다: PDF, DOCX, DOC, PPTX, PPT, XLSX, XLS, HWP, JPG, JPEG, PNG, GIF, BMP, TIF, TIFF</p>
                <p>파일을 드래그하거나 클릭하여 선택하세요 (최대 100MB)</p>
                <button class="btn" id="selectFileBtn">
                    파일 선택
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".pdf,.docx,.doc,.pptx,.ppt,.xlsx,.xls,.hwp,.jpg,.jpeg,.png,.gif,.bmp,.tif,.tiff">
            </div>

            <!-- 파일 정보 -->
            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
            </div>

            <!-- 업로드 버튼 -->
            <button class="btn" id="uploadBtn" style="width: 100%; display: none;" onclick="uploadFile()">
                처리 시작
            </button>

            <!-- 진행 상황 -->
            <div class="progress-section" id="progressSection">
                <h3>처리 중...</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <ul class="progress-steps">
                    <li class="progress-step" id="step1">파일 변환 중...</li>
                    <li class="progress-step" id="step2">OCR 텍스트 추출 중...</li>
                    <li class="progress-step" id="step3">처리 완료 중...</li>
                </ul>
                <div class="spinner show"></div>
            </div>

            <!-- 에러 메시지 -->
            <div class="error-message" id="errorMessage"></div>

            <!-- 결과 영역 -->
            <div class="result-section" id="resultSection">
                <div class="result-header">
                    <h3 class="result-title">처리 완료</h3>
                </div>

                <div class="result-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="entityCount">0</div>
                        <div class="stat-label">추출된 엔티티</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="processingTime">0s</div>
                        <div class="stat-label">처리 시간</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="ocrEngine">-</div>
                        <div class="stat-label">OCR 엔진</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="modelUsed">-</div>
                        <div class="stat-label">NER 모델</div>
                    </div>
                </div>

                <h4 style="margin-top: 30px; margin-bottom: 15px; color: #333;">엔티티 타입별 분포</h4>
                <div class="entities-grid" id="entitiesGrid"></div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn download-btn" id="downloadEntitiesBtn" style="flex: 1;">
                        추출 엔티티 다운로드
                    </button>
                    <button class="btn download-btn" id="downloadStatsBtn" style="flex: 1; background: #10b981;">
                        통계 리포트 다운로드
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let currentRequestId = null;

        // localStorage에서 이전 선택 불러오기
        function loadPreviousSelections() {
            const savedModel = localStorage.getItem('selectedModel');

            // NER 모델 복원
            if (savedModel) {
                const modelRadio = document.querySelector(`input[name="model"][value="${savedModel}"]`);
                if (modelRadio) {
                    // 기존 선택 해제
                    document.querySelectorAll('input[name="model"]').forEach(r => {
                        r.parentElement.classList.remove('selected');
                        r.checked = false;
                    });
                    // 저장된 선택 복원
                    modelRadio.checked = true;
                    modelRadio.parentElement.classList.add('selected');
                }
            }
        }


        // Universal OCR 설정 항상 표시
        document.getElementById('universalOcrSettings').style.display = 'block';
        
        // Initialize Alibaba model selection visibility
        const alibabaModelSelection = document.getElementById('alibabaModelSelection');
        const selectedProvider = document.querySelector('input[name="universal_provider"]:checked');
        if (selectedProvider && selectedProvider.value === 'alibaba') {
            alibabaModelSelection.style.display = 'block';
        } else {
            alibabaModelSelection.style.display = 'none';
        }

        // Universal OCR 제공자 선택 UI
        document.querySelectorAll('input[name="universal_provider"]').forEach(radio => {
            radio.parentElement.addEventListener('click', function() {
                document.querySelectorAll('input[name="universal_provider"]').forEach(r => {
                    r.parentElement.classList.remove('selected');
                });
                this.classList.add('selected');
                this.querySelector('input[type="radio"]').checked = true;
                
                // Alibaba 모델 선택 표시/숨김
                const alibabaModelSelection = document.getElementById('alibabaModelSelection');
                if (this.querySelector('input[type="radio"]').value === 'alibaba') {
                    alibabaModelSelection.style.display = 'block';
                } else {
                    alibabaModelSelection.style.display = 'none';
                }
            });
        });

        // Alibaba 모델 선택 UI
        document.querySelectorAll('input[name="alibaba_model"]').forEach(radio => {
            radio.parentElement.addEventListener('click', function() {
                document.querySelectorAll('input[name="alibaba_model"]').forEach(r => {
                    r.parentElement.classList.remove('selected');
                });
                this.classList.add('selected');
                this.querySelector('input[type="radio"]').checked = true;
            });
        });

        // Checkbox 옵션 UI
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    this.parentElement.classList.add('selected');
                } else {
                    this.parentElement.classList.remove('selected');
                }
            });
        });

        // 모델 선택 UI
        document.querySelectorAll('input[name="model"]').forEach(radio => {
            radio.parentElement.addEventListener('click', function() {
                document.querySelectorAll('input[name="model"]').forEach(r => {
                    r.parentElement.classList.remove('selected');
                });
                this.classList.add('selected');
                this.querySelector('input[type="radio"]').checked = true;
                
                // localStorage에 저장
                localStorage.setItem('selectedModel', this.querySelector('input[type="radio"]').value);
            });
        });

        // Add icons to NER models
        function addNerModelIcons() {
            const nerModels = document.querySelectorAll('input[name="model"]');
            nerModels.forEach(radio => {
                const modelName = radio.parentElement.querySelector('.model-name');
                if (modelName && !modelName.querySelector('.model-icon')) {
                    let iconSvg = '';
                    
                    if (radio.value === 'klue-roberta-large') {
                        iconSvg = `<svg class="model-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" fill="#8B5CF6"/>
                        </svg>`;
                    } else if (radio.value === 'xlm-roberta') {
                        iconSvg = `<svg class="model-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" fill="#F59E0B"/>
                        </svg>`;
                    } else if (radio.value === 'google-bert') {
                        iconSvg = `<svg class="model-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                        </svg>`;
                    }
                    
                    if (iconSvg) {
                        modelName.innerHTML = iconSvg + modelName.textContent;
                    }
                }
            });
        }

        // 페이지 로드 시 이전 선택 복원
        window.addEventListener('DOMContentLoaded', function() {
            loadPreviousSelections();
            addNerModelIcons();
        });

        // 파일 업로드 영역 설정
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');

        // 버튼 클릭 이벤트 (이벤트 전파 중지)
        selectFileBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // 상위로 이벤트 전파 방지
            fileInput.click();
        });

        // 업로드 영역 클릭 (버튼 영역 제외)
        uploadArea.addEventListener('click', (e) => {
            // 버튼을 클릭한 경우가 아니면 파일 선택
            if (e.target !== selectFileBtn && !selectFileBtn.contains(e.target)) {
                fileInput.click();
            }
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            selectedFile = file;
            
            // 파일 정보 표시
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = `크기: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            document.getElementById('fileInfo').classList.add('show');
            document.getElementById('uploadBtn').style.display = 'block';
            
            // 이전 결과 숨기기
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('errorMessage').classList.remove('show');
        }

        async function uploadFile() {
            if (!selectedFile) {
                alert('파일을 선택해주세요');
                return;
            }

            const selectedModelRadio = document.querySelector('input[name="model"]:checked');
            
            // UI 초기화
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('progressSection').classList.add('show');
            document.getElementById('resultSection').classList.remove('show');
            document.getElementById('errorMessage').classList.remove('show');
            
            updateProgress(0, 1);

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);
                formData.append('model', selectedModelRadio.value);

                // Universal OCR 처리
                    const selectedProviderRadio = document.querySelector('input[name="universal_provider"]:checked');
                    const selectedAlibabaModelRadio = document.querySelector('input[name="alibaba_model"]:checked');
                    const streamingModeCheckbox = document.getElementById('streamingMode');
                    
                    if (!selectedProviderRadio) {
                        alert('Universal OCR 제공자를 선택해주세요');
                        return;
                    }

                    formData.append('provider', selectedProviderRadio.value);
                    if (selectedAlibabaModelRadio) {
                        formData.append('model', selectedAlibabaModelRadio.value);
                    }
                    if (streamingModeCheckbox.checked) {
                        formData.append('stream', 'true');
                    }

                    updateProgress(33, 2);

                    const response = await fetch('/api/ocr-universal', {
                        method: 'POST',
                        body: formData
                    });

                    // Check if this is a streaming response
                    if (streamingModeCheckbox.checked) {
                        // Show result section for streaming
                        document.getElementById('resultSection').classList.add('show');
                        
                        // Handle streaming response
                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        let streamingText = '';
                        
                        // Create streaming result display
                        const streamingDiv = document.createElement('div');
                        streamingDiv.className = 'streaming-result';
                        streamingDiv.innerHTML = '<h3>실시간 OCR 결과</h3><div class="streaming-content"></div>';
                        document.getElementById('resultSection').appendChild(streamingDiv);
                        
                        const contentDiv = streamingDiv.querySelector('.streaming-content');
                        
                        try {
                            while (true) {
                                const { done, value } = await reader.read();
                                if (done) break;
                                
                                const chunk = decoder.decode(value, { stream: true });
                                streamingText += chunk;
                                contentDiv.textContent = streamingText;
                                contentDiv.scrollTop = contentDiv.scrollHeight;
                            }
                            
                            // Update statistics for streaming results
                            updateStreamingStats(streamingText, selectedProviderRadio.value, selectedAlibabaModelRadio ? selectedAlibabaModelRadio.value : null);
                            
                            updateProgress(100, 3, true);
                            setTimeout(() => {
                                document.getElementById('progressSection').classList.remove('show');
                            }, 500);
                            
                        } catch (error) {
                            showError('스트리밍 처리 중 오류가 발생했습니다: ' + error.message);
                        }
                    } else {
                        // Handle regular JSON response
                        const result = await response.json();

                        if (result.success) {
                            updateProgress(100, 3, true);
                            
                            setTimeout(() => {
                                showUniversalOcrResults(result);
                                document.getElementById('progressSection').classList.remove('show');
                            }, 500);
                        } else {
                            showError(result.error || 'Universal OCR 처리 중 오류가 발생했습니다');
                        }
                    }

            } catch (error) {
                console.error('Upload error:', error);
                showError('서버 연결 오류: ' + error.message);
            } finally {
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        function updateProgress(percent, step, completed = false) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressBar').textContent = percent + '%';

            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
                
                if (i < step || completed) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                }
            }
        }

        function showUniversalOcrResults(result) {
            currentRequestId = result.request_id;

            // 통계 표시
            document.getElementById('entityCount').textContent = result.total_text_length || 0;
            document.getElementById('processingTime').textContent = result.processing_time + 's';
            document.getElementById('ocrEngine').textContent = result.provider || 'Universal OCR';
            document.getElementById('modelUsed').textContent = result.model || 'N/A';

            // 결과 표시
            document.getElementById('resultSection').classList.add('show');
            
            // 다운로드 버튼 설정
            const downloadBtn = document.getElementById('downloadEntitiesBtn');
            downloadBtn.textContent = 'OCR 텍스트 다운로드';
            downloadBtn.onclick = () => {
                const blob = new Blob([result.extracted_text || ''], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${result.filename}_ocr.txt`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const statsBtn = document.getElementById('downloadStatsBtn');
            statsBtn.textContent = '처리 결과 다운로드';
            statsBtn.onclick = () => {
                const statsData = {
                    filename: result.filename,
                    provider: result.provider,
                    model: result.model,
                    processing_time: result.processing_time,
                    total_pages: result.total_pages,
                    total_text_length: result.total_text_length,
                    success: result.success
                };
                const blob = new Blob([JSON.stringify(statsData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${result.filename}_ocr_stats.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            // 엔티티 그리드 숨기기 (OCR만 처리)
            document.getElementById('entitiesGrid').innerHTML = '<p style="text-align: center; color: #666;">Universal OCR 처리 완료</p>';
        }

        function updateStreamingStats(streamingText, provider, model) {
            // Update statistics for streaming results
            document.getElementById('entityCount').textContent = streamingText.length;
            document.getElementById('processingTime').textContent = '스트리밍';
            document.getElementById('ocrEngine').textContent = provider.toUpperCase();
            document.getElementById('modelUsed').textContent = model || provider;

            // Setup download buttons for streaming results
            const downloadBtn = document.getElementById('downloadEntitiesBtn');
            downloadBtn.textContent = 'OCR 텍스트 다운로드';
            downloadBtn.onclick = () => {
                const blob = new Blob([streamingText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `streaming_ocr_result.txt`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const statsBtn = document.getElementById('downloadStatsBtn');
            statsBtn.textContent = '처리 결과 다운로드';
            statsBtn.onclick = () => {
                const statsData = {
                    provider: provider,
                    model: model || provider,
                    processing_mode: 'streaming',
                    text_length: streamingText.length,
                    timestamp: new Date().toISOString(),
                    success: true
                };
                const blob = new Blob([JSON.stringify(statsData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `streaming_ocr_stats.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            // 엔티티 그리드 업데이트
            document.getElementById('entitiesGrid').innerHTML = '<p style="text-align: center; color: #666;">스트리밍 OCR 처리 완료</p>';
        }

        function showResults(result) {
            currentRequestId = result.request_id;

            // 통계 표시
            document.getElementById('entityCount').textContent = result.entity_count;
            document.getElementById('processingTime').textContent = result.processing_time + 's';
            document.getElementById('ocrEngine').textContent = result.ocr_engine.split(' ')[0];
            document.getElementById('modelUsed').textContent = result.model.split(' ')[0];

            // 엔티티 타입별 카드 생성
            const entitiesGrid = document.getElementById('entitiesGrid');
            entitiesGrid.innerHTML = '';

            const entities = result.entities;
            const entityTypes = {
                'NAME': '이름',
                'DATE': '날짜',
                'COMPANY': '회사/기관',
                'LOCATION': '장소',
                'ADDRESS': '주소',
                'PHONE': '전화번호',
                'EMAIL': '이메일',
                'MONEY': '금액',
                'OTHER': '기타'
            };

            for (const [type, koreanName] of Object.entries(entityTypes)) {
                const count = entities[type] || 0;
                if (count > 0) {
                    const card = document.createElement('div');
                    card.className = 'entity-card';
                    card.innerHTML = `
                        <div class="entity-type">${koreanName}</div>
                        <div class="entity-count">${count}</div>
                    `;
                    entitiesGrid.appendChild(card);
                }
            }

            // 결과 영역 표시
            document.getElementById('resultSection').classList.add('show');

            // 다운로드 버튼 설정
            document.getElementById('downloadEntitiesBtn').onclick = () => {
                window.location.href = `/download/${currentRequestId}?type=entities`;
            };
            
            document.getElementById('downloadStatsBtn').onclick = () => {
                window.location.href = `/download/${currentRequestId}?type=stats`;
            };
        }

        function showError(message) {
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = '❌ ' + message;
            errorEl.classList.add('show');
            document.getElementById('progressSection').classList.remove('show');
        }
    </script>
</body>
</html>
